{% extends "base.html" %}

{% block content %}
<section class="card">
  <h2>Smart Store - Fridge Dashboard</h2>
  <p>Live readings for all connected fridges.</p>

  <div class="fridge-grid">
    {% for f in fridges %}
      <article class="fridge-card" data-fridge-id="{{ f.id }}">
        <header class="fridge-header">
          <h3>{{ f.name }}</h3>
          <span class="pill" data-fan="{{ f.id }}">
            {% if f.fan_on %}Fan: ON{% else %}Fan: OFF{% endif %}
          </span>
        </header>

        <div class="fridge-readings">
          <p>
            <strong>Temperature:</strong>
            <span data-temp="{{ f.id }}">{{ f.temperature }} °C</span>
          </p>
          <p>
            <strong>Humidity:</strong>
            <span data-hum="{{ f.id }}">{{ f.humidity }} %</span>
          </p>
          <p class="updated">
            Last update:
            <span data-updated="{{ f.id }}">{{ f.updated_at }}</span>
          </p>
        </div>

        <form class="threshold-form" method="post"
              action="{% url 'fridge_thresholds' f.id %}">
          {% csrf_token %}
          <label>
            Temp threshold (°C)
            <input type="number" step="0.1" name="temp_threshold"
                   value="{{ f.temp_threshold }}">
          </label>
          <label>
            Humidity threshold (%)
            <input type="number" step="0.1" name="humidity_threshold"
                   value="{{ f.humidity_threshold }}">
          </label>
          <button class="btn small" type="submit">Save thresholds</button>
        </form>

        <form class="fan-form" method="post"
              action="{% url 'fridge_fan_toggle' f.id %}">
          {% csrf_token %}
          <input type="hidden" name="action"
                 value="{% if f.fan_on %}OFF{% else %}ON{% endif %}">
          <button class="btn secondary" type="submit">
            {% if f.fan_on %}Turn fan OFF{% else %}Turn fan ON{% endif %}
          </button>
        </form>
      </article>
    {% empty %}
      <p>No fridges configured yet.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Poll latest readings every 5 seconds and update the cards
setInterval(() => {
  fetch("{% url 'fridge_latest' %}")
    .then(r => r.json())
    .then(data => {
      for (const f of data.fridges) {
        const id = f.id;
        const tempSpan = document.querySelector(`[data-temp="${id}"]`);
        const humSpan = document.querySelector(`[data-hum="${id}"]`);
        const updSpan = document.querySelector(`[data-updated="${id}"]`);
        const fanPill = document.querySelector(`[data-fan="${id}"]`);

        if (tempSpan) tempSpan.textContent = `${f.temperature} °C`;
        if (humSpan) humSpan.textContent = `${f.humidity} %`;
        if (updSpan) updSpan.textContent = f.updated_at;
        if (fanPill) fanPill.textContent = `Fan: ${f.fan_on ? "ON" : "OFF"}`;
      }
    })
    .catch(() => {});
}, 5000);
</script>
{% endblock %}
