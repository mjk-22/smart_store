{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<section class="card">
  <h2>Smart Store - Fridge Dashboard</h2>
  <p>Live readings for all connected fridges.</p>

    <div class="gauge-grid">
        {% for f in fridges %}
        <article class="gauge-card" data-fridge-id="{{ f.id }}">
            <header class="gauge-header">
                <h3>{{ f.name }}</h3>
                <span class="pill" data-fan="{{ f.id }}">
                    {% trans "Fan" %} : {% if f.fan_on %}ON{% else %}OFF{% endif %} (auto)
                </span>
            </header>

            <div class="gauge-row">
                <!-- Temperature gauge -->
                <div class="gauge-panel">
                    <div class="gauge-value">
                        <span id="tempVal-{{ f.id }}">--</span> °C
                    </div>
                    <canvas id="tempGauge-{{ f.id }}"></canvas>
                    <div class="gauge-label">{% trans "Temp" %} </div>
                    <div class="gauge-scale">{% trans "Scale" %} : 0–40 °C</div>
                </div>

                <!-- Humidity gauge -->
                <div class="gauge-panel">
                    <div class="gauge-value">
                        <span id="humVal-{{ f.id }}">--</span> %
                    </div>
                    <canvas id="humGauge-{{ f.id }}"></canvas>
                    <div class="gauge-label">{% trans "Humidity" %} </div>
                    <div class="gauge-scale">{% trans "Scale" %} : 0–100 %</div>
                </div>
            </div>

            <footer class="gauge-footer">
                <form class="threshold-form" method="post"
                      action="{% url 'fridge_thresholds' f.id %}">
                    {% csrf_token %}
                    <label>
                        {% trans "Temp threshold" %}  (°C)
                        <input type="number" step="0.1"
                               name="temp_threshold"
                               value="{{ f.temp_threshold }}">
                    </label>
                    <label>
                        {% trans "Humidity threshold" %}  (%)
                        <input type="number" step="0.1"
                               name="humidity_threshold"
                               value="{{ f.humidity_threshold }}">
                    </label>
                    <button class="btn secondary small" type="submit">
                        {% trans "Save thresholds" %} 
                    </button>
                </form>

                <div class="updated">
                    {% trans "Last update" %} :
                    <span data-updated="{{ f.id }}">{{ f.updated_at }}</span>
                </div>
            </footer>
        </article>
        {% empty %}
        <p>{% trans "No fridges configured yet." %} </p>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Poll latest readings every 5 seconds and update the cards
setInterval(() => {
  fetch("{% url 'fridge_latest' %}")
    .then(r => r.json())
    .then(data => {
      for (const f of data.fridges) {
        const id = f.id;
        const tempSpan = document.querySelector(`[data-temp="${id}"]`);
        const humSpan = document.querySelector(`[data-hum="${id}"]`);
        const updSpan = document.querySelector(`[data-updated="${id}"]`);
        const fanPill = document.querySelector(`[data-fan="${id}"]`);

        if (tempSpan) tempSpan.textContent = `${f.temperature} °C`;
        if (humSpan) humSpan.textContent = `${f.humidity} %`;
        if (updSpan) updSpan.textContent = f.updated_at;
        if (fanPill) fanPill.textContent = `Fan: ${f.fan_on ? "ON" : "OFF"}`;
      }
    })
    .catch(() => {});
}, 5000);
</script>
{% endblock %}
